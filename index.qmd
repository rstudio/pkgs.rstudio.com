---
title: "Selected R Packages, from Posit"
description: >
  A selection of open-source R packages developed and maintained by Posit for
  the R community.

format:
  html:
    embed-resources: true

    theme: zephyr
    linkcolor: "#447099"
    title-block-banner: "#FFFFFF"
    title-block-banner-color: "#17212b"

    include-in-header:
      file: GA.html
    include-before-body:
      file: noscript.html

editor:
  render-on-save: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(dplyr)
library(tidyr)
library(stringr)
library(glue)
library(rvest)
library(purrr)
library(reactable)
library(htmltools)

# utils
get_og_meta <- function(url, property = "title", default = "") {
  ret <- tryCatch({
    html <- read_html(url)
    html %>%
      html_node(glue("meta[property='og:{property}']")) %>%
      html_attr("content")
  }, error = function(err) {
    message(url, ": ", err$message)
    NA_character_
  })

  if (!is.na(ret)) ret else default
}

prep_package_record <- function(x, pkg_name) {
  stopifnot(!is.null(x$url$host))

  x$url_host <- x$url$host
  x$url_pkgs <- x$url$pkgs %||% glue("https://pkgs.rstudio.com/{pkg_name}/")
  x$url <- NULL

  x$about <- x$about %||% get_og_meta(x$url_host, "title")
  x$hex_logo <- x$hex_logo %||%
    get_og_meta(x$url_host, "image", default = "hex-placeholder.svg")

  as_tibble(x)
}
```

```{r import-redirects, include=FALSE}
# read in the redirect file
redirect_names <- c("pkg", "old_url", "status")
pkgs_redirects <- readr::read_table("_redirects",
                          col_names = redirect_names) %>%
  # remove generic redirection
  filter(pkg != "/*") %>%
  # retrieve information
  mutate(pkg = str_sub(pkg, start = 2L, end = -3L),
         pkgs_url = glue("https://pkgs.rstudio.com/{pkg}/"))
```

```{r import-packages, include = FALSE}
pkgs <-
  yaml::read_yaml("packages.yml") |>
  imap(prep_package_record) |>
  list_rbind(names_to = "pkg")

if (!all(pkgs_redirects$pkg %in% pkgs$pkg)) {
  stop("Not all packages in `_redirects` are in `packages.yml`")
}

pkgs_url_mismatch <-
  left_join(pkgs_redirects, pkgs, by = c("pkg")) |>
  filter(pkgs_url != url_pkgs)

if (nrow(pkgs_url_mismatch)) {
  stop("URLs in `_redirects` do not match those listed in `packages.yml`")
}
```

```{r table}
#| column: body-outset

# make the table
pkgs_tbl <- pkgs %>% select(hex_logo, pkg, about, url = url_pkgs)

reactable(
  data = pkgs_tbl,

  # global reactable options
  searchable = TRUE,
  highlight = TRUE,
  defaultPageSize = 25,
  rowStyle = list(cursor = "pointer"),
  theme = reactableTheme(
    highlightColor = "#e6f3fc"),

  # formatting individual columns
  columns = list(
    pkg = colDef(
      name = "Package",
      width = 150,
      cell = function(value, index) {
        tags$a(href = pkgs_tbl$url[index], target = "_blank", value)
      }
    ),
    about = colDef(name = "About"),
    # Using htmltools to render a link
    url = reactable::colDef(show = FALSE),
    hex_logo = colDef(
      cell = function(value) {
        image <- img(src = value, height = "50px")
        tagList(
          div(
            style = list(display = "inline-block", width = "43.3px"),
            image
          )
        )
      },
      width = 75,
      name = ""
    )
  )
)
```

---

::: {.text-center}
Proudly supported by
[![](https://www.rstudio.com/assets/img/posit-logo-fullcolor-TM.svg){fig-alt="Posit" width=65px}](https://posit.co)
:::
